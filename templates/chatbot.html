{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Bot ‚Äî Campus Connect</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Sans:wght@300;400;500&display=swap"
        rel="stylesheet" />
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --green: #00e676;
            --pink: #ff4d9e;
            --dark: #0a0a0a;
            --bot-accent: #a5d6a7;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--dark);
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* NAVBAR */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 40px;
            background: #0d0d0d;
            border-bottom: 1px solid #1e1e1e;
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }

        .nav-logo img { width: 85px; }

        .nav-center { display: flex; gap: 6px; }

        .nav-link {
            text-decoration: none;
            font-family: 'Syne', sans-serif;
            font-size: 0.76rem;
            letter-spacing: 0.08em;
            padding: 8px 18px;
            border-radius: 50px;
            color: rgba(255,255,255,0.45);
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: #fff;
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.1);
        }

        .nav-link.active {
            color: var(--green);
            border-color: rgba(0,230,118,0.25);
            background: rgba(0,230,118,0.06);
        }

        .nav-right { display: flex; align-items: center; gap: 10px; position: relative; }

        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50px;
            padding: 6px 14px 6px 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
            text-decoration: none;
        }

        .profile-btn:hover { border-color: var(--green); }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--green), var(--pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Syne', sans-serif;
            font-size: 0.72rem;
            font-weight: 700;
            color: #000;
            overflow: hidden;
        }

        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .profile-name { font-size: 0.8rem; font-weight: 500; }

        .dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: #161616;
            border: 1px solid #2a2a2a;
            border-radius: 14px;
            padding: 8px;
            min-width: 180px;
            display: none;
            z-index: 200;
            box-shadow: 0 16px 40px rgba(0,0,0,0.5);
        }

        .dropdown.open { display: block; animation: fadeUp 0.2s ease; }

        .dropdown a {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            text-decoration: none;
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .dropdown a:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .dropdown hr { border: none; border-top: 1px solid #222; margin: 6px 0; }
        .dropdown a.danger:hover { background: rgba(255,77,77,0.08); color: #ff6b6b; }

        /* PAGE LAYOUT */
        .chat-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 860px;
            width: 100%;
            margin: 0 auto;
            padding: 0 24px 24px;
            height: calc(100vh - 61px);
        }

        /* CHAT HEADER */
        .chat-header {
            padding: 28px 0 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid #1a1a1a;
            flex-shrink: 0;
        }

        .bot-avatar {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(135deg, #a5d6a7, #00e676);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            position: relative;
            flex-shrink: 0;
        }

        .bot-avatar::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00e676;
            border: 2px solid var(--dark);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.85); }
        }

        .bot-info h2 {
            font-family: 'Syne', sans-serif;
            font-size: 1rem;
            font-weight: 700;
        }

        .bot-info p {
            font-size: 0.78rem;
            color: rgba(255,255,255,0.35);
            margin-top: 2px;
        }

        .bot-info p span {
            color: #00e676;
            font-weight: 500;
        }

        .clear-btn {
            margin-left: auto;
            background: rgba(255,255,255,0.04);
            border: 1px solid #1e1e1e;
            border-radius: 50px;
            padding: 7px 16px;
            color: rgba(255,255,255,0.35);
            font-family: 'DM Sans', sans-serif;
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            border-color: #ff4d9e;
            color: #ff4d9e;
            background: rgba(255,77,158,0.06);
        }

        /* MESSAGES */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scrollbar-width: thin;
            scrollbar-color: #1e1e1e transparent;
        }

        .messages::-webkit-scrollbar { width: 4px; }
        .messages::-webkit-scrollbar-track { background: transparent; }
        .messages::-webkit-scrollbar-thumb { background: #1e1e1e; border-radius: 4px; }

        /* Welcome state */
        .welcome-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 12px;
            padding: 40px 0;
            animation: fadeUp 0.5s ease;
        }

        .welcome-icon {
            font-size: 3rem;
            margin-bottom: 4px;
        }

        .welcome-state h3 {
            font-family: 'Syne', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: #fff;
        }

        .welcome-state p {
            font-size: 0.88rem;
            color: rgba(255,255,255,0.35);
            text-align: center;
            max-width: 360px;
            line-height: 1.6;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .suggestion-chip {
            padding: 8px 16px;
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 50px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            border-color: var(--bot-accent);
            color: var(--bot-accent);
            background: rgba(165,214,167,0.06);
        }

        /* Message bubbles */
        .message {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            animation: fadeUp 0.3s ease;
        }

        .message.user { flex-direction: row-reverse; }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .msg-avatar.bot {
            background: linear-gradient(135deg, #a5d6a7, #00e676);
        }

        .msg-avatar.user-av {
            background: linear-gradient(135deg, var(--green), var(--pink));
            font-family: 'Syne', sans-serif;
            font-size: 0.7rem;
            font-weight: 700;
            color: #000;
        }

        .bubble {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 16px;
            font-size: 0.88rem;
            line-height: 1.65;
        }

        .message.bot .bubble {
            background: #111;
            border: 1px solid #1e1e1e;
            border-bottom-left-radius: 4px;
            color: rgba(255,255,255,0.85);
        }

        .message.user .bubble {
            background: rgba(0,230,118,0.1);
            border: 1px solid rgba(0,230,118,0.2);
            border-bottom-right-radius: 4px;
            color: #fff;
        }

        .bubble-time {
            font-size: 0.68rem;
            color: rgba(255,255,255,0.2);
            margin-top: 5px;
            display: block;
        }

        .message.user .bubble-time { text-align: right; }

        /* Typing indicator */
        .typing-bubble {
            display: flex;
            gap: 5px;
            align-items: center;
            padding: 14px 18px;
        }

        .typing-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: rgba(255,255,255,0.25);
            animation: typingBounce 1.2s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
            30% { transform: translateY(-6px); opacity: 1; }
        }

        /* INPUT AREA */
        .input-area {
            flex-shrink: 0;
            padding: 16px 0 4px;
            border-top: 1px solid #1a1a1a;
        }

        .input-box {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: #111;
            border: 1px solid #1e1e1e;
            border-radius: 16px;
            padding: 10px 10px 10px 18px;
            transition: border-color 0.2s;
        }

        .input-box:focus-within {
            border-color: rgba(165,214,167,0.4);
        }

        #chat-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: #fff;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
            padding: 4px 0;
        }

        #chat-input::placeholder { color: rgba(255,255,255,0.2); }

        .send-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            background: var(--bot-accent);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover { background: #00e676; transform: scale(1.05); }
        .send-btn:active { transform: scale(0.95); }

        .send-btn:disabled {
            background: #1e1e1e;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg { width: 16px; height: 16px; fill: #000; }

        .input-hint {
            text-align: center;
            font-size: 0.7rem;
            color: rgba(255,255,255,0.15);
            margin-top: 10px;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 560px) {
            nav { padding: 12px 18px; }
            .nav-center { display: none; }
            .chat-wrapper { padding: 0 14px 14px; }
            .bubble { max-width: 85%; }
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav>
        <div class="nav-logo">
            <a href="{% url 'home' %}"><img src="{% static 'images/logo.png' %}" alt="Campus Connect" /></a>
        </div>
        <div class="nav-center">
            <a href="{% url 'announcements' %}" class="nav-link">üì¢ Announcements</a>
            <a href="{% url 'study' %}" class="nav-link active">üìö Study</a>
        </div>
        <div class="nav-right">
            <div class="profile-btn" onclick="toggleDD()">
                <div class="avatar">
                    {% if profile and profile.avatar %}<img src="{{ profile.avatar.url }}" alt="" />
                    {% elif user.first_name %}{{ user.first_name.0|upper }}
                    {% else %}{{ user.username.0|upper }}{% endif %}
                </div>
                <span class="profile-name">{{ user.first_name|default:user.username }}</span>
                <span style="font-size:0.6rem;color:rgba(255,255,255,0.3);margin-left:2px;">‚ñº</span>
            </div>
            <div class="dropdown" id="dd">
                <a href="{% url 'profile' %}">üë§ View Profile</a>
                <a href="{% url 'edit_profile' %}">‚úèÔ∏è Edit Profile</a>
                <hr />
                <a href="{% url 'logout' %}" class="danger">üö™ Logout</a>
            </div>
        </div>
    </nav>

    <!-- CHAT WRAPPER -->
    <div class="chat-wrapper">

        <!-- CHAT HEADER -->
        <div class="chat-header">
            <div class="bot-avatar">ü§ñ</div>
            <div class="bot-info">
                <h2>Campus AI Assistant</h2>
                <p><span>‚óè Online</span> ¬∑ Ready to help with any academic question</p>
            </div>
            <button class="clear-btn" onclick="clearChat()">üóë Clear chat</button>
        </div>

        <!-- MESSAGES -->
        <div class="messages" id="messages">
            <!-- Welcome state shown initially -->
            <div class="welcome-state" id="welcome-state">
                <div class="welcome-icon">ü§ñ</div>
                <h3>How can I help you today?</h3>
                <p>Ask me anything ‚Äî from explaining concepts to solving problems, summarizing topics, or helping with assignments.</p>
                <div class="suggestions">
                    <div class="suggestion-chip" onclick="useSuggestion(this)">Explain Big O notation</div>
                    <div class="suggestion-chip" onclick="useSuggestion(this)">What is the OSI model?</div>
                    <div class="suggestion-chip" onclick="useSuggestion(this)">Help me with linear algebra</div>
                    <div class="suggestion-chip" onclick="useSuggestion(this)">Tips for exam preparation</div>
                    <div class="suggestion-chip" onclick="useSuggestion(this)">Explain machine learning basics</div>
                </div>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div class="input-area">
            <div class="input-box">
                <textarea
                    id="chat-input"
                    rows="1"
                    placeholder="Ask anything academic..."
                    onkeydown="handleKey(event)"
                    oninput="autoResize(this)"
                ></textarea>
                <button class="send-btn" id="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </div>
            <p class="input-hint">Press Enter to send ¬∑ Shift+Enter for new line</p>
        </div>

    </div>

    <script>
        // Navbar dropdown
        function toggleDD() {
            document.getElementById('dd').classList.toggle('open');
        }
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.nav-right')) {
                document.getElementById('dd').classList.remove('open');
            }
        });

        // Chat state
        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const welcomeState = document.getElementById('welcome-state');
        let isThinking = false;

        // Chat history for context (sent to Django backend)
        let chatHistory = [];

        function getTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function getUserInitial() {
            // Try to get from nav avatar text
            const av = document.querySelector('.avatar');
            return av ? av.innerText.trim() || '?' : '?';
        }

        function appendMessage(role, text) {
            // Hide welcome state on first message
            welcomeState.style.display = 'none';

            const msg = document.createElement('div');
            msg.className = `message ${role}`;

            const avDiv = document.createElement('div');
            if (role === 'bot') {
                avDiv.className = 'msg-avatar bot';
                avDiv.textContent = 'ü§ñ';
            } else {
                avDiv.className = 'msg-avatar user-av';
                avDiv.textContent = getUserInitial();
            }

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = formatText(text) + `<span class="bubble-time">${getTime()}</span>`;

            msg.appendChild(avDiv);
            msg.appendChild(bubble);
            messagesEl.appendChild(msg);
            scrollToBottom();
            return msg;
        }

        function formatText(text) {
            // Basic markdown-like formatting
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background:#1e1e1e;padding:2px 6px;border-radius:5px;font-family:monospace;font-size:0.85em;">$1</code>')
                .replace(/\n/g, '<br>');
        }

        function showTyping() {
            const msg = document.createElement('div');
            msg.className = 'message bot';
            msg.id = 'typing-indicator';

            const avDiv = document.createElement('div');
            avDiv.className = 'msg-avatar bot';
            avDiv.textContent = 'ü§ñ';

            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = `<div class="typing-bubble">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>`;

            msg.appendChild(avDiv);
            msg.appendChild(bubble);
            messagesEl.appendChild(msg);
            scrollToBottom();
        }

        function removeTyping() {
            const t = document.getElementById('typing-indicator');
            if (t) t.remove();
        }

        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function useSuggestion(el) {
            inputEl.value = el.textContent;
            autoResize(inputEl);
            inputEl.focus();
        }

        async function sendMessage() {
            const text = inputEl.value.trim();
            if (!text || isThinking) return;

            isThinking = true;
            sendBtn.disabled = true;
            inputEl.value = '';
            inputEl.style.height = 'auto';

            // Add user message
            appendMessage('user', text);
            chatHistory.push({ role: 'user', content: text });

            // Show typing
            showTyping();

            try {
                const response = await fetch("{% url 'chatbot_api' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ message: text, history: chatHistory })
                });

                const data = await response.json();
                removeTyping();

                const reply = data.reply || "Sorry, I couldn't process that. Please try again.";
                appendMessage('bot', reply);
                chatHistory.push({ role: 'assistant', content: reply });

            } catch (err) {
                removeTyping();
                appendMessage('bot', "‚ö†Ô∏è Something went wrong. Please check your connection and try again.");
            }

            isThinking = false;
            sendBtn.disabled = false;
            inputEl.focus();
        }

        function clearChat() {
            chatHistory = [];
            // Remove all messages except welcome state
            const msgs = messagesEl.querySelectorAll('.message');
            msgs.forEach(m => m.remove());
            welcomeState.style.display = 'flex';
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>
</html>